setTimeout(function() {
  fadeOutPreloader(document.getElementById('preloader'), 69);
}, 1500);

$(document).ready(function() {
  $(window).on('beforeunload', function() {
    window.scrollTo(0, 0);
  });

  /* particlesJS.load(@dom-id, @path-json, @callback (optional)); */
  particlesJS.load('landing', 'assets/particles.json', function() {});

  // Typing Text
  var element = document.getElementById('txt-rotate');
  var toRotate = element.getAttribute('data-rotate');
  var period = element.getAttribute('data-period');
  setTimeout(function() {
    new TxtRotate(element, JSON.parse(toRotate), period);
  }, 1500);

  // INJECT CSS
  var css = document.createElement('style');
  css.type = 'text/css';
  css.innerHTML = '#txt-rotate > .wrap { border-right: 0.08em solid #666 }';
  document.body.appendChild(css);

  // Initialize AOS
  AOS.init({
    disable: 'mobile',
    offset: 200,
    duration: 600,
    easing: 'ease-in-sine',
    delay: 100,
    once: true
  });

  randomizeOrder();
  initSectionDock();
  sortNewsFeedByDate();
  initLogoRain();
});

/* FUNCTIONS */
/* Preloader */

function fadeOutPreloader(element, duration) {
  var opacity = 1;

  var interval = setInterval(function() {
    if (opacity <= 0) {
      element.style.zIndex = 0;
      element.style.opacity = 0;
      element.style.filter = 'alpha(opacity = 0)';

      // Allow vertical scroll
      document.documentElement.style.overflowY = 'auto';

      // Remove preloader div
      document.getElementById('preloader').remove();

      clearInterval(interval);
    } else {
      opacity -= 0.1;
      element.style.opacity = opacity;
      element.style.filter = 'alpha(opacity = ' + opacity * 100 + ')';
    }
  }, duration);
}

/* Typing Text */

var TxtRotate = function(el, toRotate, period) {
  this.toRotate = toRotate;
  this.el = el;
  this.loopNum = 0;
  this.period = parseInt(period, 10) || 2000;
  this.txt = '';
  this.tick();
  this.isDeleting = false;
};

TxtRotate.prototype.tick = function() {
  var i = this.loopNum % this.toRotate.length;
  var fullTxt = this.toRotate[i];

  if (this.isDeleting) {
    this.txt = fullTxt.substring(0, this.txt.length - 1);
  } else {
    this.txt = fullTxt.substring(0, this.txt.length + 1);
  }
  this.el.innerHTML = '<span class="wrap">' + this.txt + '</span>';

  var that = this;
  var delta = 200 - Math.random() * 100;

  if (this.isDeleting) {
    delta /= 5;
  }

  if (!this.isDeleting && this.txt === fullTxt) {
    delta = this.period;
    this.isDeleting = true;
  } else if (this.isDeleting && this.txt === '') {
    this.isDeleting = false;
    this.loopNum++;
    delta = 500;
  }

  setTimeout(function() {
    that.tick();
  }, delta);
};

/* Word Cloud */

function randomizeOrder() {
  var parent = document.getElementById('skills');
  if (!parent) {
    return;
  }

  var divs = parent.getElementsByTagName('div');
  var frag = document.createDocumentFragment();

  // Randomize order of skills
  while (divs.length) {
    frag.appendChild(divs[Math.floor(Math.random() * divs.length)]);
  }
  parent.appendChild(frag);
}

/* Bottom Dock */

function initSectionDock() {
  var dock = document.getElementById('section-dock');
  if (!dock) {
    return;
  }

  var links = Array.prototype.slice.call(
    dock.querySelectorAll('.section-dock-link')
  );

  if (!links.length) {
    return;
  }

  var modeSections = {
    research: document.getElementById('research'),
    news: document.getElementById('news')
  };

  var hasModeToggle = !!(modeSections.research && modeSections.news);
  var researchDock = document.getElementById('research-dock');
  var researchLinks = researchDock
    ? Array.prototype.slice.call(researchDock.querySelectorAll('.section-dock-link'))
    : [];

  function isVisibleSection(section) {
    return !!section && !section.classList.contains('section-mode-hidden');
  }

  function setSectionMode(mode) {
    if (!hasModeToggle || !modeSections[mode]) {
      return;
    }

    Object.keys(modeSections).forEach(function(key) {
      var section = modeSections[key];
      var shouldShow = key === mode;
      section.classList.toggle('section-mode-hidden', !shouldShow);
      section.setAttribute('aria-hidden', String(!shouldShow));
    });

    if (researchDock) {
      researchDock.classList.toggle('section-mode-hidden', mode !== 'research');
      researchDock.setAttribute('aria-hidden', String(mode !== 'research'));
    }
  }

  function setActive(targetId) {
    links.forEach(function(link) {
      link.classList.toggle('is-active', link.getAttribute('data-target') === targetId);
    });
  }

  function setResearchActive(targetId) {
    researchLinks.forEach(function(link) {
      link.classList.toggle('is-active', link.getAttribute('data-target') === targetId);
    });
  }

  function closestSectionId() {
    var viewportFocus = window.innerHeight * 0.35;
    var bestId = links[0].getAttribute('data-target');
    var bestDistance = Number.POSITIVE_INFINITY;

    links.forEach(function(link) {
      var id = link.getAttribute('data-target');
      var section = document.getElementById(id);
      if (!section || !isVisibleSection(section)) {
        return;
      }

      var rect = section.getBoundingClientRect();
      var inFocusRange = rect.top <= viewportFocus && rect.bottom >= viewportFocus;
      var distance = inFocusRange ? 0 : Math.abs(rect.top - viewportFocus);

      if (distance < bestDistance) {
        bestDistance = distance;
        bestId = id;
      }
    });

    return bestId;
  }

  function closestResearchSectionId() {
    if (!researchLinks.length || !researchDock || researchDock.classList.contains('section-mode-hidden')) {
      return '';
    }

    var viewportFocus = window.innerHeight * 0.35;
    var bestId = researchLinks[0].getAttribute('data-target');
    var bestDistance = Number.POSITIVE_INFINITY;

    researchLinks.forEach(function(link) {
      var id = link.getAttribute('data-target');
      var section = document.getElementById(id);
      if (!section || !isVisibleSection(section)) {
        return;
      }

      var rect = section.getBoundingClientRect();
      var inFocusRange = rect.top <= viewportFocus && rect.bottom >= viewportFocus;
      var distance = inFocusRange ? 0 : Math.abs(rect.top - viewportFocus);

      if (distance < bestDistance) {
        bestDistance = distance;
        bestId = id;
      }
    });

    return bestId;
  }

  links.forEach(function(link) {
    link.addEventListener('click', function(event) {
      event.preventDefault();

      var mode = link.getAttribute('data-view');
      if (mode) {
        setSectionMode(mode);
      } else if (researchDock && link.getAttribute('data-target') !== 'research') {
        researchDock.classList.add('section-mode-hidden');
        researchDock.setAttribute('aria-hidden', 'true');
      }

      var targetId = link.getAttribute('data-target');
      var target = document.getElementById(targetId);
      if (!target || !isVisibleSection(target)) {
        return;
      }

      target.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });

      setActive(targetId);
      if (window.history && window.history.replaceState) {
        window.history.replaceState(null, '', '#' + targetId);
      }
    });
  });

  researchLinks.forEach(function(link) {
    link.addEventListener('click', function(event) {
      event.preventDefault();

      var targetId = link.getAttribute('data-target');
      var target = document.getElementById(targetId);
      if (!target || !isVisibleSection(target)) {
        return;
      }

      target.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });

      setResearchActive(targetId);
      if (window.history && window.history.replaceState) {
        window.history.replaceState(null, '', '#' + targetId);
      }
    });
  });

  if (hasModeToggle) {
    var hashTarget = window.location.hash.replace('#', '');
    if (hashTarget === 'news') {
      setSectionMode('news');
    } else if (hashTarget === 'research') {
      setSectionMode('research');
    }
  }

  var ticking = false;
  function requestActiveUpdate() {
    if (ticking) {
      return;
    }

    ticking = true;
    window.requestAnimationFrame(function() {
      setActive(closestSectionId());

      var activeResearch = closestResearchSectionId();
      if (activeResearch) {
        setResearchActive(activeResearch);
      }

      ticking = false;
    });
  }

  window.addEventListener('scroll', requestActiveUpdate, { passive: true });
  window.addEventListener('resize', requestActiveUpdate);

  requestActiveUpdate();
}

function sortNewsFeedByDate() {
  var feed = document.getElementById('combined-news-feed');
  if (!feed) {
    return;
  }

  var items = Array.prototype.slice.call(feed.querySelectorAll('.news-item'));
  if (!items.length) {
    return;
  }

  items.sort(function(a, b) {
    var dateA = parseInt(a.getAttribute('data-news-date'), 10) || 0;
    var dateB = parseInt(b.getAttribute('data-news-date'), 10) || 0;
    return dateB - dateA;
  });

  items.forEach(function(item) {
    feed.appendChild(item);
  });

  initNewsFeedPagination(feed, items);
}

function initNewsFeedPagination(feed, sortedItems) {
  var loadMoreLink = document.getElementById('news-load-more');
  if (!loadMoreLink) {
    return;
  }

  var items = sortedItems && sortedItems.length
    ? sortedItems
    : Array.prototype.slice.call(feed.querySelectorAll('.news-item'));

  if (!items.length) {
    loadMoreLink.classList.add('news-load-more-hidden');
    loadMoreLink.setAttribute('aria-hidden', 'true');
    return;
  }

  var initialVisibleCount = 20;
  var revealStep = 50;
  var visibleCount = Math.min(initialVisibleCount, items.length);

  function render() {
    items.forEach(function(item, index) {
      item.classList.toggle('news-item-hidden', index >= visibleCount);
    });

    var hasMore = visibleCount < items.length;
    loadMoreLink.classList.toggle('news-load-more-hidden', !hasMore);
    loadMoreLink.setAttribute('aria-hidden', String(!hasMore));
  }

  loadMoreLink.addEventListener('click', function(event) {
    event.preventDefault();
    visibleCount = Math.min(items.length, visibleCount + revealStep);
    render();
  });

  render();
}

/* Rare Logo Rain */

function initLogoRain() {
  var landing = document.getElementById('landing');
  if (!landing) {
    return;
  }

  var layer = document.createElement('div');
  layer.className = 'logo-rain-layer';
  landing.appendChild(layer);

  var config = {
    logos: ['assets/img/ms8logo.png', 'assets/img/UoHlogo.png', 'assets/img/Dislogo.svg', 'assets/img/fulogo.png'],
    color: '#61B0B7',
    chancePerTick: 0.48,
    tickMs: 900,
    maxVisible: 8,
    sizeMin: 30,
    sizeMax: 66,
    opacityMin: 0.35,
    opacityMax: 0.75,
    durationMin: 9000,
    durationMax: 17000,
    driftMin: -40,
    driftMax: 40,
    sizeMultiplierByLogo: {
      'assets/img/ms8logo.png': 2,
      'assets/img/UoHlogo.png': 2,
      'assets/img/Dislogo.svg': 2,
      'assets/img/fulogo.png': 4
    }
  };

  var activeDrops = 0;

  function rand(min, max) {
    return min + Math.random() * (max - min);
  }

  function spawn() {
    var src = config.logos[Math.floor(Math.random() * config.logos.length)];
    var drop = document.createElement('span');
    drop.className = 'logo-rain-drop';

    var multiplier = config.sizeMultiplierByLogo[src] || 1;
    var size = rand(config.sizeMin, config.sizeMax) * multiplier;
    var opacity = rand(config.opacityMin, config.opacityMax);
    var duration = rand(config.durationMin, config.durationMax);
    var drift = rand(config.driftMin, config.driftMax);

    drop.style.left = rand(0, 100) + '%';
    drop.style.width = size.toFixed(2) + 'px';
    drop.style.height = size.toFixed(2) + 'px';
    drop.style.opacity = opacity.toFixed(2);
    drop.style.animationDuration = duration.toFixed(0) + 'ms';
    drop.style.setProperty('--logo-drift', drift.toFixed(2) + 'px');

    // Colorize PNG via CSS mask when available; fallback keeps original PNG.
    drop.style.backgroundColor = config.color;
    drop.style.backgroundImage = 'url("' + src + '")';
    drop.style.webkitMaskImage = 'url("' + src + '")';
    drop.style.maskImage = 'url("' + src + '")';

    layer.appendChild(drop);
    activeDrops += 1;

    var cleaned = false;
    function cleanup() {
      if (cleaned) {
        return;
      }
      cleaned = true;
      drop.remove();
      activeDrops = Math.max(0, activeDrops - 1);
    }

    drop.addEventListener('animationend', cleanup, { once: true });
    setTimeout(cleanup, duration + 500);
  }

  function maybeSpawn() {
    if (document.hidden) {
      return;
    }

    if (activeDrops >= config.maxVisible) {
      return;
    }

    if (Math.random() < config.chancePerTick) {
      spawn();
    }
  }

  setInterval(maybeSpawn, config.tickMs);
}
